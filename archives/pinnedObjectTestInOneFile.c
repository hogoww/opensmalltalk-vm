/* includes */#include "VMPinnedObjectTest.h"extern void openOn(char*);/* Definitions */CuSuite* VMPinnedObjectTestGetSuite(){ CuSuite* suite; suite = CuSuiteNew(); SUITE_ADD_TEST(suite, testAllocatingObjectAfterTwoPinObjectShouldSlideAtStartOfOldSpace);  SUITE_ADD_TEST(suite, testAllocatingObjectAfterManyPinnedObjectShouldSlideBeforeFirstPinned);  SUITE_ADD_TEST(suite, testPinnedObjectShouldNotBeMovedByGC); SUITE_ADD_TEST(suite, testPinANewObjectShouldMoveItToTheOldSpaceAndLeaveAForwarderBehind); SUITE_ADD_TEST(suite, testAllocatingObjectAfterAPinObjectShouldSlideAtStartOfOldSpace); SUITE_ADD_TEST(suite, testAllocatingObjectAfterManyPinnedObjectShouldSlideAtStartOfOldSpace); SUITE_ADD_TEST(suite, testPinANewObjectShouldMoveItToTheOldSpace); SUITE_ADD_TEST(suite, testAllocatingObjectAfterAPinObjectShouldSlideBeforeLastPinnedObject); SUITE_ADD_TEST(suite, testAllocatingObjectRightAfterPinnedShouldMoveItOnFirstDead); return suite;}VMPinnedObjectTest keepObjectInVMVariable1(VMPinnedObjectTest self, sqInt anOop){ newMethod = anOop;}VMPinnedObjectTest keepObjectInVMVariable2(VMPinnedObjectTest self, sqInt anOop){ profileSemaphore = anOop;}sqInt keptObjectInVMVariable1(VMPinnedObjectTest self){ return newMethod;}sqInt keptObjectInVMVariable2(VMPinnedObjectTest self){ return profileSemaphore;}sqInt lastAliveObject(VMPinnedObjectTest self){ return keptObjectInVMVariable2(self);}sqInt lastPinnedObject(VMPinnedObjectTest self){ return keptObjectInVMVariable1(self);}sqInt newAliveObject(VMPinnedObjectTest self){ sqInt newAliveObject = newOldSpaceObjectWithSlots(self, 1); storePointerofObjectwithValue(0, newAliveObject, keptObjectInVMVariable2(self)); keepObjectInVMVariable2(self, newAliveObject); return newAliveObject;}sqInt newDeadObject(VMPinnedObjectTest self){ return newOldSpaceObjectWithSlots(self, 1);}sqInt newKeptPinnedObject(VMPinnedObjectTest self){ sqInt newPinned = newOldSpaceObjectWithSlots(self, 1); pinObject(newPinned); storePointerofObjectwithValue(0, newPinned, keptObjectInVMVariable1(self)); keepObjectInVMVariable1(self, newPinned); return newPinned;}sqInt newObjectWithSlots(VMPinnedObjectTest self, int slots){  return newObjectWithSlotsclassIndex(self, slots, arrayClassIndexPun());}sqInt newObjectWithSlotsclassIndex(VMPinnedObjectTest self, int slots, sqInt anIndex){ return newObjectWithSlotsformatclassIndex(self, slots, arrayFormat(), anIndex);}sqInt newObjectWithSlotsformatclassIndex(VMPinnedObjectTest self, int slots, sqInt aFormat, sqInt anIndex){ sqInt oop = allocateSlotsformatclassIndex(slots, aFormat, anIndex); if (oop) {  fillObjnumSlotswith(oop, slots, nilObj); } return oop;}sqInt newOldSpaceObjectWithSlots(VMPinnedObjectTest self, int slots){  return newOldSpaceObjectWithSlotsclassIndex(self, slots, arrayClassIndexPun());}sqInt newOldSpaceObjectWithSlotsclassIndex(VMPinnedObjectTest self, int slots, sqInt anIndex){ return newOldSpaceObjectWithSlotsformatclassIndex(self, slots, arrayFormat(), anIndex);}sqInt newOldSpaceObjectWithSlotsformatclassIndex(VMPinnedObjectTest self, int slots, sqInt aFormat, sqInt anIndex){ sqInt oop = allocateSlotsInOldSpaceformatclassIndex(slots, aFormat, anIndex); if (oop) {  fillObjnumSlotswith(oop, slots, nilObj); } return oop;}void setUp(VMPinnedObjectTest self){ openOn("/home/ariale/ovm/testCompilation/tempconversion-64.image"); initStackPages(); loadInitialContext(); self . objectHeaderSize = 8; self . emptyObjectSize = self . objectHeaderSize + 8; self . newSpaceSize = oldSpaceStart() - newSpaceStart; self . oldSpaceSize = totalBytesInSegments();}void tearDown(VMPinnedObjectTest self){}void testAllocatingObjectAfterAPinObjectShouldSlideAtStartOfOldSpace(CuTest* testCase){ VMPinnedObjectTest self; setUp(self); fullGC(); sqInt destination = newDeadObject(self); sqInt shouldBeFreed = newDeadObject(self); newKeptPinnedObject(self); newDeadObject(self); sqInt aliveObject = newAliveObject(self); fullGC(); CuAssertTrue(testCase, isForwarded(aliveObject)); CuAssertTrue(testCase, (lastAliveObject(self) == destination)); CuAssertTrue(testCase, isFreeObject(shouldBeFreed)); tearDown(self);}void testAllocatingObjectAfterAPinObjectShouldSlideBeforeLastPinnedObject(CuTest* testCase){ VMPinnedObjectTest self; setUp(self); fullGC(); sqInt destination = newDeadObject(self); newKeptPinnedObject(self); newDeadObject(self); sqInt aliveObject = newAliveObject(self); fullGC(); CuAssertTrue(testCase, isForwarded(aliveObject)); CuAssertTrue(testCase, (lastAliveObject(self) == destination)); tearDown(self);}void testAllocatingObjectAfterManyPinnedObjectShouldSlideAtStartOfOldSpace(CuTest* testCase){ VMPinnedObjectTest self; setUp(self); fullGC(); sqInt destination = newDeadObject(self); sqInt shouldBeFreed = newDeadObject(self); newKeptPinnedObject(self); newKeptPinnedObject(self); newDeadObject(self); sqInt aliveObject = newAliveObject(self); fullGC(); CuAssertTrue(testCase, isForwarded(aliveObject)); CuAssertTrue(testCase, (lastAliveObject(self) == destination)); CuAssertTrue(testCase, isFreeObject(shouldBeFreed)); tearDown(self);}void testAllocatingObjectAfterManyPinnedObjectShouldSlideBeforeFirstPinned(CuTest* testCase){ VMPinnedObjectTest self; setUp(self); fullGC(); sqInt destination = newDeadObject(self); newKeptPinnedObject(self); newKeptPinnedObject(self); newDeadObject(self); sqInt aliveObject = newAliveObject(self); fullGC(); CuAssertTrue(testCase, isForwarded(aliveObject)); CuAssertTrue(testCase, (lastAliveObject(self) == destination)); tearDown(self);}void testAllocatingObjectAfterTwoPinObjectShouldSlideAtStartOfOldSpace(CuTest* testCase){ VMPinnedObjectTest self; setUp(self); fullGC(); sqInt destination = newDeadObject(self); newKeptPinnedObject(self); sqInt shouldBeFreed = newDeadObject(self); newKeptPinnedObject(self); newDeadObject(self); sqInt aliveObject = newAliveObject(self); fullGC(); CuAssertTrue(testCase, isForwarded(aliveObject)); CuAssertTrue(testCase, (lastAliveObject(self) == destination)); CuAssertTrue(testCase, isFreeObject(shouldBeFreed)); tearDown(self);}void testAllocatingObjectRightAfterPinnedShouldMoveItOnFirstDead(CuTest* testCase){ VMPinnedObjectTest self; setUp(self); fullGC(); sqInt destination = newDeadObject(self); newKeptPinnedObject(self); sqInt aliveObject = newAliveObject(self); sqInt aliveObjectHash = rawHashBitsOf(aliveObject); fullGC(); CuAssertTrue(testCase, (aliveObjectHash == rawHashBitsOf(destination))); CuAssertTrue(testCase, isFreeObject(objectAfter(lastPinnedObject(self)))); tearDown(self);}void testPinANewObjectShouldMoveItToTheOldSpace(CuTest* testCase){ VMPinnedObjectTest self; setUp(self); sqInt obj = newObjectWithSlots(self, 0); keepObjectInVMVariable1(self, obj); pinObject(obj); CuAssertTrue(testCase, isInOldSpace(followForwarded(obj))); tearDown(self);}void testPinANewObjectShouldMoveItToTheOldSpaceAndLeaveAForwarderBehind(CuTest* testCase){ VMPinnedObjectTest self; setUp(self); sqInt obj = newObjectWithSlots(self, 0); keepObjectInVMVariable1(self, obj); pinObject(obj); CuAssertTrue(testCase, isForwarded(obj)); tearDown(self);}void testPinnedObjectShouldNotBeMovedByGC(CuTest* testCase){ VMPinnedObjectTest self; setUp(self); newOldSpaceObjectWithSlots(self, 0); sqInt pinned = newObjectWithSlots(self, 0); pinObject(pinned); keepObjectInVMVariable1(self, followForwarded(pinned)); fullGC(); CuAssertTrue(testCase, (!isForwarded(keptObjectInVMVariable1(self)))); tearDown(self);}